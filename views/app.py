#!/usr/bin/env python

import tornado.ioloop
from tornado.web import RequestHandler, Application

# from analytics import SummaryStats

import datetime
import os


class StatsHandler(RequestHandler):
    def get(self):
        self.render("stats.html", title="Get Summary Stats on Generated Bike Trips")

    def post(self):
        try:
            start_date = datetime.datetime.strptime(self.get_argument("start"),
                                                    "%m-%d-%Y %H:%M")
            end_date = datetime.datetime.strptime(self.get_argument("end"),
                                                  "%m-%d-%Y %H:%M")

            # sstats = SummaryStats(start_date, end_date)
            
            # stub for testing GUI
            self.write(
            '{"num_arrivals_per_station": {"31232": 2, "31233": 3, "31234": 0, "31235": 1, "31236": 1, "31237": 3, "31238": 3, "31239": 2, "31240": 0, "31241": 0, "31242": 0, "31243": 0, "31244": 2, "31245": 1, "31246": 0, "31247": 0, "31248": 0, "31249": 0, "31250": 0, "31251": 0, "31252": 0, "31253": 0, "31254": 0, "31255": 0, "31256": 0, "31257": 0, "31258": 0, "31259": 0, "31260": 0, "31261": 0, "31262": 0, "31263": 0, "31264": 0, "31265": 0, "31266": 0, "31267": 0, "31268": 0, "31269": 0, "31270": 0, "31271": 0, "31272": 0, "32007": 0, "31627": 0, "31800": 0, "31801": 0, "31802": 0, "31803": 0, "31804": 1, "31805": 0, "31806": 0, "31807": 0, "31300": 0, "31301": 1, "31302": 0, "31303": 0, "31304": 1, "31305": 0, "31306": 0, "31307": 0, "31308": 0, "31309": 0, "31310": 0, "32013": 0, "31312": 0, "32014": 0, "31117": 0, "32015": 0, "31066": 0, "32016": 0, "31629": 0, "31114": 0, "32018": 0, "31507": 0, "31118": 0, "32020": 0, "32021": 0, "32023": 0, "31512": 0, "31119": 0, "31513": 0, "31514": 0, "31400": 0, "31401": 1, "31402": 0, "31403": 0, "31404": 0, "31405": 0, "31406": 0, "31407": 0, "32012": 0, "31612": 0, "31101": 1, "31614": 2, "31615": 1, "32000": 0, "31616": 1, "32002": 0, "31019": 0, "32004": 0, "32005": 0, "32006": 0, "31617": 0, "32008": 0, "32009": 0, "32010": 0, "32011": 0, "31500": 0, "31501": 0, "31502": 0, "31503": 1, "31504": 1, "31505": 1, "31506": 0, "31619": 1, "31508": 0, "31509": 0, "31510": 0, "31511": 0, "31000": 0, "31001": 0, "31002": 0, "31003": 1, "31004": 0, "31005": 0, "31006": 0, "31007": 2, "31008": 0, "31009": 0, "31010": 0, "31011": 1, "31012": 1, "31013": 0, "31014": 0, "31015": 0, "31016": 0, "31017": 1, "31018": 0, "31623": 7, "31020": 0, "31021": 0, "31022": 0, "31023": 0, "31024": 0, "31624": 5, "31026": 0, "31027": 0, "31028": 0, "31029": 0, "31030": 0, "31625": 1, "31032": 0, "31033": 0, "31034": 0, "31035": 0, "31036": 0, "31037": 0, "31038": 0, "31039": 0, "31040": 0, "31041": 0, "31042": 0, "31043": 0, "31044": 0, "31045": 0, "31046": 0, "31047": 0, "31048": 0, "31628": 0, "31050": 0, "31031": 0, "31052": 0, "31053": 0, "31054": 0, "31055": 0, "31056": 0, "31057": 0, "31058": 0, "31059": 0, "31621": 4, "31061": 0, "31062": 0, "31063": 0, "31064": 0, "31065": 0, "31620": 3, "31067": 0, "31068": 0, "31069": 0, "31120": 0, "31600": 1, "31601": 0, "31602": 3, "31603": 1, "31604": 2, "31605": 1, "31606": 0, "31607": 1, "31608": 0, "31609": 0, "31610": 1, "31611": 2, "31100": 3, "31613": 1, "31102": 0, "31103": 1, "31104": 1, "31105": 1, "31106": 2, "31107": 0, "31108": 1, "31109": 1, "31110": 4, "31111": 2, "31112": 0, "31113": 0, "31626": 0, "31115": 0, "31116": 1, "31025": 0, "31630": 0, "31631": 0, "31632": 0, "31633": 0, "31634": 0, "31635": 0, "31622": 0, "31060": 0, "32003": 0, "31618": 0, "31049": 0, "31051": 0, "32001": 0, "31700": 0, "31701": 0, "31702": 0, "31703": 0, "31704": 0, "31705": 0, "31706": 0, "31707": 0, "31708": 0, "31709": 0, "31200": 1, "31201": 6, "31202": 3, "31203": 5, "31204": 5, "31205": 4, "31206": 1, "31207": 0, "31208": 1, "31209": 0, "31211": 0, "31212": 2, "31213": 3, "31214": 1, "31215": 3, "31216": 3, "31217": 5, "31218": 1, "31219": 2, "31220": 3, "31221": 3, "31222": 2, "31223": 1, "31224": 2, "31225": 4, "31226": 0, "31227": 2, "31228": 5, "31229": 0, "31230": 7, "31231": 1}, "total_num_disappointments": 50, "min_duration_trip": {"end_station_id": 31231, "duration": -4869.089184, "start_datetime": "2014-01-14T14:44:28", "end_datetime": "2014-01-14T13:23:18.910816", "start_station_id": 31228}, "max_duration_trip": {"end_station_id": 31301, "duration": 16032.16448, "start_datetime": "2014-01-14T09:57:14", "end_datetime": "2014-01-14T14:24:26.164480", "start_station_id": 31301}, "total_num_trips": 163, "std_trip_time": 1447.4643832300956, "avg_trip_time": 755.65452934355835, "num_departures_per_station": {"31232": 1, "31233": 4, "31234": 0, "31235": 2, "31236": 1, "31237": 1, "31238": 1, "31239": 0, "31240": 0, "31241": 10, "31242": 0, "31243": 0, "31244": 2, "31245": 0, "31246": 1, "31247": 0, "31248": 0, "31249": 0, "31250": 0, "31251": 0, "31252": 0, "31253": 0, "31254": 0, "31255": 0, "31256": 0, "31257": 0, "31258": 0, "31259": 0, "31260": 0, "31261": 0, "31262": 0, "31263": 0, "31264": 0, "31265": 0, "31266": 0, "31267": 0, "31268": 0, "31269": 0, "31270": 0, "31271": 0, "31272": 0, "32007": 0, "31627": 0, "31800": 0, "31801": 0, "31802": 0, "31803": 0, "31804": 0, "31805": 0, "31806": 0, "31807": 0, "31300": 1, "31301": 1, "31302": 0, "31303": 1, "31304": 1, "31305": 0, "31306": 0, "31307": 0, "31308": 0, "31309": 0, "31310": 0, "32013": 0, "31312": 0, "32014": 0, "31117": 0, "32015": 0, "31066": 0, "32016": 0, "31629": 0, "31114": 0, "32018": 0, "31507": 0, "31118": 0, "32020": 0, "32021": 0, "32023": 0, "31512": 0, "31119": 0, "31513": 0, "31514": 0, "31400": 1, "31401": 2, "31402": 0, "31403": 0, "31404": 1, "31405": 0, "31406": 0, "31407": 0, "32012": 0, "31612": 0, "31101": 2, "31614": 0, "31615": 1, "32000": 0, "31616": 0, "32002": 0, "31019": 0, "32004": 0, "32005": 0, "32006": 0, "31617": 1, "32008": 0, "32009": 0, "32010": 0, "32011": 0, "31500": 0, "31501": 1, "31502": 0, "31503": 1, "31504": 1, "31505": 0, "31506": 3, "31619": 2, "31508": 0, "31509": 0, "31510": 0, "31511": 0, "31000": 0, "31001": 0, "31002": 0, "31003": 0, "31004": 1, "31005": 0, "31006": 0, "31007": 3, "31008": 0, "31009": 1, "31010": 0, "31011": 0, "31012": 1, "31013": 0, "31014": 1, "31015": 0, "31016": 0, "31017": 0, "31018": 0, "31623": 12, "31020": 0, "31021": 0, "31022": 1, "31023": 0, "31024": 0, "31624": 6, "31026": 0, "31027": 0, "31028": 0, "31029": 0, "31030": 0, "31625": 0, "31032": 0, "31033": 0, "31034": 0, "31035": 0, "31036": 0, "31037": 0, "31038": 0, "31039": 0, "31040": 0, "31041": 0, "31042": 0, "31043": 0, "31044": 0, "31045": 0, "31046": 0, "31047": 0, "31048": 0, "31628": 0, "31050": 0, "31031": 0, "31052": 0, "31053": 0, "31054": 0, "31055": 0, "31056": 0, "31057": 0, "31058": 0, "31059": 0, "31621": 0, "31061": 0, "31062": 0, "31063": 0, "31064": 0, "31065": 0, "31620": 1, "31067": 0, "31068": 0, "31069": 0, "31120": 0, "31600": 1, "31601": 0, "31602": 1, "31603": 1, "31604": 3, "31605": 0, "31606": 0, "31607": 1, "31608": 2, "31609": 1, "31610": 2, "31611": 4, "31100": 4, "31613": 0, "31102": 0, "31103": 0, "31104": 1, "31105": 3, "31106": 2, "31107": 0, "31108": 1, "31109": 1, "31110": 3, "31111": 0, "31112": 0, "31113": 0, "31626": 0, "31115": 0, "31116": 2, "31025": 0, "31630": 0, "31631": 0, "31632": 0, "31633": 0, "31634": 0, "31635": 0, "31622": 0, "31060": 0, "32003": 0, "31618": 1, "31049": 0, "31051": 0, "32001": 0, "31700": 0, "31701": 0, "31702": 1, "31703": 0, "31704": 0, "31705": 0, "31706": 0, "31707": 0, "31708": 0, "31709": 0, "31200": 3, "31201": 1, "31202": 2, "31203": 2, "31204": 1, "31205": 5, "31206": 0, "31207": 0, "31208": 1, "31209": 0, "31211": 0, "31212": 3, "31213": 1, "31214": 3, "31215": 1, "31216": 3, "31217": 2, "31218": 1, "31219": 0, "31220": 2, "31221": 1, "31222": 0, "31223": 4, "31224": 3, "31225": 1, "31226": 1, "31227": 0, "31228": 6, "31229": 8, "31230": 2, "31231": 1}}'
            )
            # self.write(sstats.get_stats())

        except Exception as inst:
            print "usage: /raw?logic=PoissonLogic&start=<start-date>&end=<end-date>"
            print inst
    
class IndexHandler(RequestHandler):
    def get(self):
        self.render("home.html", title="BikeShare Comps")

class AboutHandler(RequestHandler):
    def get(self):
        self.render("about.html", title="About Us")

class BaseHandler(RequestHandler):
    def get(self):
        self.render("base.html", title="Base File")

if __name__ == "__main__":
    dirname = os.path.dirname(__file__)
    settings = {
        "static_path" : os.path.join(dirname, "static"),
        "template_path" : os.path.join(dirname, "templates")
    }
    application = Application([
        (r"/", IndexHandler),
        (r"/base", BaseHandler),
        (r"/about", AboutHandler),
        (r"/stats", StatsHandler)
    ], **settings)
    
    application.listen(3000)
    tornado.ioloop.IOLoop.instance().start()
